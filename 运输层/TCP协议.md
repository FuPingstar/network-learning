# TCP协议

## 概述

1. TCP主要特点

   + 点对点
     + 一个发送方、一个接收方
   + 流水线机制
     + **TCP拥塞控制和流量控制设置窗口尺寸**

   + TCP是面向连接的运输层协议
     + 应用程序在使用TCP协议之前，必须先建立TCP连接。在传输完数据之后，必须释放已经建立的TCP连接。
       + 连接状态指在连接的两端中维护，在沿途的节点中并不需要维护。
     + TCP连接包括：两台主机上的缓存、连接状态变量、socket
   + TCP提供可靠交付的服务。
     + TCP连接传送的数据，无差错，不丢失，不重复，并且可以按序到达。
   + TCP提供全双工通信。
     + **TCP允许通信双方的应用进程任何时候都能够发送数据。TCP连接的两端都设有发送缓存和接收缓存，用来临时存放通信双方的数据。**
   + 面向可靠按序字节流。
     + **TCP中流 的概念是流入到进程或者从进程流出的字节序列。**
   + 流量控制机制

## TCP报文段格式

​	![TCP段结构](/images/运输层/TCP段结构.png)

**TCP报文段首部的前20个字节是固定的，后面有4N个字节是根据需求而增加的选项（N是整数）。因此TCP首部的最小长度是20个字节。**

1. 源端口和目的端口：各占两个字。和UDP类似，TCP的分用功能也是通过端口实现的。
2. 序号（报文段序号）：在一个TCP连接中，传送的字节流中的每一个字节都要按顺序编号。整个要传送的字节流的其实序号必须在建立连接时设置。**首部中序号指的是本报文段所发送的数据的第一个字节的序号。**
3. 确认号：占4个字节，是**期望收到对方下一个报文段的第一个数据字节的序号**。

   + 若确认号为N，则表明：到序号N-1未知的所有数据都已经正确接收。
4. 数据偏移：占4位，指的是TCP报文段的数据其实处距离TCP报文段的起始处有多远。这个字段其实指的是TCP报文段的首部长度。由于首部中还有长度不确定的选项，所有偏移量字段是必须的。
5. 保留：占6位，今后使用，全为0
6. 紧急URG（URGent）：当URG=1，表明紧急指针字段有效。它告诉系统此报文段中有紧急数据，应尽快传送。
7. 确认ACK（ACKnowlegement）：ACK=1确认号字段有效，ACK=0，确认号字段无效。TCP规定，建立连接后，所有传送的报文段都必须把ACK置1
8. 推送PSH（Push）：当两个应用进程通信时，一端 的应用进程希望在键入一个命令后立即能够收到对方的响应，把PSH置为1，接收方TCP收到PSH=的报文段，就尽快的交付给应用进程，而不再等到缓存满了。
9. 复位RST（ReSeT）；RST=1，表明TCP连接出现严重差错，必须释放连接。还用来拒绝一个非法的报文段或者非法连接。
10. 同步SYN（SYNchronization）:在建立连接时同步序号。当SYN=1而ACK=0时，表明这是一个连接请求报文段，若对方同意连接，则应在响应报文段中使ACK=1和SYN=1.
11. 终止FIN（FINis）：用来释放连接，当FIN=1，表明此报文段的发送方的数据已经发送完毕，并要求释放运输连接。
12. 窗口：占两个字节。窗口指的是发送本报文段一方的接收窗口。窗口值告诉对方，从本报文段首部的确认号算起，接收方目前允许对方发送的数量。这是因为接收的缓存空间是有限制的。

    + 窗口字段明确指出了现在允许对方发送的数据量。窗口值是经常在变化着的。
13. 检验和：占2字节，检验和字段的检验范围包括首部和数据这两部分。
14. 紧急指针：占2字节。紧急指针仅在URG=1时有效，指出了本报文段中紧急字段的字节数。
15. 选项：长短可变，最长可达40字节。

## 三次握手 四次挥手

**不管是三次握手还是四次挥手都是由客户端发起的**

### 三次握手

#### 为什么要进行三次握手

主要是为了防止已失效的报文段忽然传到了B,因而报文错乱问题。假定A发出的第一个连接请求报文段并没有丢失，而是在某些网络结点长时间滞留了，一直延迟到连接释放后的某个时间才到达B，本来这是一个早已失效的报文段，但B收到此失效的连接请求报文段后，就误认为这是A又发出的一次新的连接请求，于是就像A发出确认报文段，同意建立连接。假定不采用三次握手，那么只要B发出确认，新的连接就建立了，这样就一直等A发来数据，B的许多资源就拜拜浪费了。

#### 流程图

![三次握手流程图](https://own-pic-bed.oss-cn-beijing.aliyuncs.com/三次握手.png)

