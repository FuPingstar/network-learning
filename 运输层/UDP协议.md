#### 用户数据报协议UDP<User Datagram Protocol>

**UDP协议基于Internet IP协议，就是在IP的数据报服务服务之上增加了很少的一点功能，这就是复用和分用的功能以及差错检测的功能。**

1. 为什么要在传输层做错误检测？

   - 传输层提供的是端到端的逻辑通信服务。可能经过多个路由器，使用不同的物理媒介和不同链路层协议，不能保证所有的链路层协议都有错误检测。
   - 即便所使用的的链路层协议有错误检测，但是在路由器的存储转发过程中也可能出现错误。

2. UDP

   - 无连接
     - UDP协议在发送数据之前不需要建立连接的，(当然发送数据结束时也没有连接可以释放)，因此减少了开销和发送数据之前的延迟。
     - 每个UDP段的处理独立于其他段。
   - 服务模型（Best  effort服务）
     - 不保证可靠交付，因此主机不需要维持复杂的连接状态表。
     - UDP段可能丢失，可能非按序到达。
   - UDP是面向报文的
     - 发送方的UDP对应用程序交下来的报文，在添加首部后就向下交付给IP层。UDP对应用层交下来的报文，既不合并，也不拆分，而是保留这些报文的边界。这就是说，应用层交给UDP多长的包文，UDP就照样发送，即一次发送一个报文。接收方的UDP，对IP层交付上来的UDP用户数据报，在去除首部后，就原封不动的交付给上层的应用进程。**UDP一次交付一个完整的报文。因此，应用进程必须选择合适大小的报文。若报文太长，UDP把它交给IP层后，IP层在传送时可能要进行分片，降低IP层效率，反之，若报文太短，UDP把它交给IP层后，会使IP数据报的首部相对长度太大，也降低了IP层的效率。**
   - UDP没有拥塞控制
     - 网络出现的拥塞不会使源主机的发送速率降低。
   - UDP支持一对一、一对多、多对一和多对多的交互通信
   - UDP的首部开销小
   - 只有8个字节。

3. UDP首部格式

   **用户数据报有两个字段：数据字段和首部字段。**

   - 首部字段只有8个字节，有四个字段。每个字段的长度都是两个字节。

     - 源端口：源端口号，在需要对方回信时选用。不需要时可以全为0.
     - 目的端口：这在终点交付报文时必须用到。
     - 长度：UDP用户报的数据长度，最小值是8，仅有首部。
     - 检验和：检测用户数据报在传输过程中是否有错。有错就丢弃。

     ![UDP用户数据报首部](/images/运输层/UDP用户数据报首部.jpg)

     **伪首部是计算校验和时，临时添加在用户数据报前面，只是为了计算校验和，既不向下传送也不向上提交。**

4. UDP计算校验和

   **UDP计算校验和的方法和计算IP数据报首部校验和的方式类似，不同的是，ip数据报的校验和只校验IP数据报的首部，但是UDP的校验和是把首部和数据部分一起校验。**

   - 发送方：
     - 首先把全零放入校验和字段。
     - 把伪首部和UDP用户数据报看成是由16位的字连接起来。若UDP用户数据报的数据部分不是偶数个字节，则要填入一个全零字节，但此字节不发送。然后按照二进制反码计算出这些16位字的和。
       - 计算所有整数的和，进位加在和的后面，将得到的值按位取反，得到校验和。
   - 接收方：
     - 把收到的UDP用户数据报连同伪首部一起，按二进制反码计算出这些16位字的和。无差错的话，结果应为全1 。否则表明有差错出现，应丢弃这个数据包。

   ![UDP计算校验和示例](/images/运输层/UDP计算校验和示例.png)

5. UDP应用

   - 流媒体引用（容忍丢失 数据敏感）
   - DNS SNMP

6. 如何在UDP上实现数据的可靠传输

   - 在应用层增加可靠性机制
   - 应用特定的错误恢复机制

   

   

   

   

   

   